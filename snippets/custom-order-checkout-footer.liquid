{%- liquid
  assign custom_item_count = 0
  assign custom_order_title = settings.custom_order_product_title | default: 'Custom Order'
  for item in cart.items
    # Check product title first (primary method)
    assign is_custom = false
    if item.product and item.product.title
      assign product_title_lower = item.product.title | downcase | strip
      assign custom_title_lower = custom_order_title | downcase | strip
      if product_title_lower == custom_title_lower
        assign is_custom = true
      endif
    endif

    # Backward compatibility: Check properties (for migration period)
    if is_custom == false and item.properties
      assign custom_flag = item.properties['Order Type'] | default: item.properties._custom
      if custom_flag
        assign custom_flag_lower = custom_flag | downcase
        if custom_flag_lower == 'custom'
          assign is_custom = true
        endif
      endif
    endif

    if is_custom
      assign custom_item_count = custom_item_count | plus: 1
    endif
  endfor

  assign footer_status_prefix = 'custom_order.checkout_footer.status_prefix' | t
  assign footer_item_count_text = 'custom_order.checkout_footer.item_count' | t
  assign footer_button_text = 'custom_order.checkout_footer.button_text' | t
-%}

<div
  class="custom-order-checkout-footer custom-banner"
  data-custom-item-count="{{ custom_item_count }}"
  {% if custom_item_count == 0 %}
    hidden
  {% endif %}
>
  <div class="checkout-footer__content">
    <div class="checkout-footer__text-container">
      <span class="checkout-footer__status">
        <strong class="checkout-footer__prefix">{{ footer_status_prefix }}</strong>
        <div class="checkout-footer__message-wrapper" data-message-wrapper>
          <span class="checkout-footer__message">
            You have <span class="checkout-footer__count">{{ custom_item_count }}</span> custom item(s) saved in the cart.
          </span>
          <span class="checkout-footer__message checkout-footer__message--duplicate" aria-hidden="true" hidden></span>
        </div>
      </span>
    </div>
    <a href="/checkout" class="button button--primary checkout-footer__button">
      {{ footer_button_text }}
    </a>
    <button
      type="button"
      class="checkout-footer__close"
      aria-label="Minimize banner"
      data-banner-close
    >
      <svg aria-hidden="true" focusable="false" width="16" height="16" viewBox="0 0 16 16">
        <path d="M8 12L3 7l1.414-1.414L8 9.172l3.586-3.586L13 7l-5 5z" fill="currentColor"/>
      </svg>
    </button>
  </div>
  <div
    class="checkout-footer__minimized"
    data-banner-minimized
    hidden
    role="button"
    tabindex="0"
    aria-label="Tap to show notification"
    title="Tap to show notification"
  >
    <div class="checkout-footer__minimized-bar">
      <svg
        class="checkout-footer__minimized-icon"
        aria-hidden="true"
        focusable="false"
        width="12"
        height="12"
        viewBox="0 0 12 12"
      >
        <path d="M6 2L2 6l4 4 4-4-4-4z" fill="currentColor" opacity="0.6"/>
      </svg>
    </div>
  </div>
</div>

{{ 'component-custom-order-checkout-footer.css' | asset_url | stylesheet_tag }}
<script src="{{ 'custom-order-checkout-footer.js' | asset_url }}" defer></script>
<script>
  (function () {
    function initCheckoutFooterBanner() {
      const footer = document.querySelector('.custom-order-checkout-footer');
      if (!footer) return;

      if (!window.CustomBannerManager) {
        // Wait for banner manager to load
        setTimeout(initCheckoutFooterBanner, 50);
        return;
      }

      const minimizedBar = footer.querySelector('[data-banner-minimized]');

      window.CustomBannerManager.initBanner({
        banner: footer,
        minimizedBar: minimizedBar,
        storageKey: 'checkoutFooter',
        autoRestoreOnShow: false,
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCheckoutFooterBanner);
    } else {
      initCheckoutFooterBanner();
    }
  })();
</script>
