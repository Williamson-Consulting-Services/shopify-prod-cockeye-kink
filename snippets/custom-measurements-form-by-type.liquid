{% comment %}
  Custom Measurements Form By Type - Product Type Aware
  Automatically detects product.type and shows only relevant measurement fields

  Parameters:
    - product: Product object (optional, defaults to current product)
    - section: Section object (required)

  Features:
    - Reads product.type from current product
    - Parses product type mapping from theme settings
    - Looks up category for current product type
    - Auto-selects category (hides category selector)
    - Shows only measurements required for that category
{% endcomment %}

{%- liquid
  assign product_obj = product | default: product
  assign section_obj = section | default: section

  # Get product type
  assign product_type = product_obj.type | default: ''

  # Parse product type mapping from settings
  assign mapped_category = ''
  assign type_map_source = settings.custom_measurements_product_type_map | default: ''

  if type_map_source != '' and product_type != ''
    assign type_map_lines = type_map_source | newline_to_br | split: '<br />'

    for line in type_map_lines
      assign line = line | strip
      if line == ''
        continue
      endif
      assign parts = line | split: ':'
      if parts.size >= 2
        assign type_name = parts[0] | strip
        assign type_name_lower = type_name | downcase
        assign product_type_lower = product_type | downcase
        if type_name == product_type or type_name_lower == product_type_lower
          assign mapped_category = parts[1] | strip
          break
        endif
      endif
    endfor
  endif

  # Load configuration
  render 'custom-measurements-config'
-%}

{{ 'component-custom-measurements.css' | asset_url | stylesheet_tag }}
{{ 'component-product-variant-picker.css' | asset_url | stylesheet_tag }}

{%- comment -%} Use settings directly - defaults are defined in settings_schema.json {%- endcomment -%}
{%- assign categories_source = settings.custom_measurements_categories_order -%}
{%- assign categories_order = categories_source | split: ',' -%}

{%- comment -%} Use mapped_category and categories_order in conditionals to ensure theme-check recognizes usage {%- endcomment -%}
{%- liquid
  if mapped_category != ''
    assign has_mapped_category = true
  else
    assign has_mapped_category = false
  endif
-%}

{%- assign measurement_map_source = settings.custom_measurements_map -%}
{%- assign measurement_map_lines = measurement_map_source | newline_to_br | split: '<br />' -%}

{%- assign measurement_names = '' | split: '|' -%}
{%- for measurement_line in measurement_map_lines -%}
  {%- assign measurement_line = measurement_line | strip -%}
  {%- if measurement_line == '' -%}{% continue %}{% endif %}
  {%- assign parts = measurement_line | split: ':' -%}
  {%- assign measurement_label = parts[0] | strip -%}
  {%- if measurement_label == '' -%}{% continue %}{% endif %}
  {%- assign measurement_label = measurement_label | remove: '*' | strip -%}
  {%- assign measurement_entry = measurement_label | split: '__split__' -%}
  {%- assign measurement_names = measurement_names | concat: measurement_entry -%}
{%- endfor -%}
{%- assign measurement_names = measurement_names | uniq -%}

{%- comment -%} Render category selector with mapped category and categories order {%- endcomment -%}
{%-
  render 'custom-measurements-category-selector',
  categories_order: categories_order,
  measurement_map_lines: measurement_map_lines,
  section_id: section_obj.id,
  auto_select_category: mapped_category,
  hide_selector: has_mapped_category
-%}
{%- comment -%} Ensure categories_order is recognized as used (used in render above) {%- endcomment -%}

{%- render 'custom-measurements-hidden-fields', section_id: section_obj.id -%}

{%- render 'custom-measurements-unit-toggle', section_id: section_obj.id -%}

{%- render 'custom-measurements-field-group', measurement_names: measurement_names, section_id: section_obj.id -%}

<script src="{{ 'custom-measurements-form.js' | asset_url }}" defer></script>
