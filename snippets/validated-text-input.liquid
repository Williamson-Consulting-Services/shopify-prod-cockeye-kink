{%- assign form_id = 'product-form-' | append: section.id -%}

<div style="margin-bottom:15px;">
  <label for="custom-engraving">Engraving (5 chars max, A-Z, 0-9):</label>

  <input
    type="text"
    id="custom-engraving"
    name="properties[Engraving]"
    maxlength="5"
    pattern="[a-zA-Z0-9]*"
    title="Only letters (A-Z) and numbers (0-9) are allowed."
    style="width: 100%; border: 1px solid #ccc; padding: 8px; border-radius: 4px; box-sizing: border-box;"
    form="{{ form_id }}"
  >

  <div id="engraving-error" style="color: #d9534f; display: none; margin-top: 5px; font-size: 0.9em;">
    Please use only 5 characters (letters and numbers).
  </div>
</div>

<script>
  (function () {
    // Find the elements for this specific instance
    const currentScript = document.currentScript;
    const section = currentScript.closest('.shopify-section');

    if (!section) return;

    // --- THIS IS THE JAVASCRIPT FIX ---
    // Get the form ID we just created in Liquid
    const formId = '{{ form_id }}';

    // Find the form by its *exact* ID. This is much more reliable.
    const productForm = document.getElementById(formId);
    const customInput = section.querySelector('#custom-engraving');
    const errorMsg = section.querySelector('#engraving-error');

    if (!productForm || !customInput || !errorMsg) {
      console.warn('Custom validation script could not find all required elements.');
      return;
    }

    // --- Real-time validation function (no change) ---
    function validateInput() {
      if (!customInput.checkValidity()) {
        errorMsg.style.display = 'block';
        customInput.style.borderColor = '#d9534f';
        customInput.style.boxShadow = '0 0 0 1px #d9534f';
        return false;
      } else {
        errorMsg.style.display = 'none';
        customInput.style.borderColor = '#ccc';
        customInput.style.boxShadow = 'none';
        return true;
      }
    }

    // --- Run validation on every keystroke (no change) ---
    customInput.addEventListener('input', validateInput);

    // --- Keep the 'submit' check as a final safeguard (no change) ---
    productForm.addEventListener('submit', function (event) {
      if (!validateInput()) {
        event.preventDefault(); // Stop the 'Add to Cart'
      }
    });
  })();
</script>
