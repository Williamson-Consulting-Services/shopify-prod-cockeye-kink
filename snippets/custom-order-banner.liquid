{%- liquid
  assign banner_editing_translation = 'custom_order.banner.editing' | t
  assign banner_editing_text = settings.custom_order_banner_editing_text | default: banner_editing_translation

  assign banner_background_color = settings.custom_order_banner_background_color | default: '#ffec99'
  assign banner_text_color = settings.custom_order_banner_text_color | default: '#3f2f00'
  assign banner_shadow_color = settings.custom_order_banner_shadow_color | default: '#000000'
  assign banner_shadow_opacity = settings.custom_order_banner_shadow_opacity | default: 20
  assign banner_shadow_alpha = banner_shadow_opacity | divided_by: 100.0
  assign banner_shadow_rgba = banner_shadow_color | color_modify: 'alpha', banner_shadow_alpha
-%}

<div
  id="custom-order-banner"
  class="custom-order-banner"
  role="status"
  aria-live="polite"
  hidden
  style="--custom-order-banner-bg: {{ banner_background_color }}; --custom-order-banner-color: {{ banner_text_color }}; --custom-order-banner-shadow: {{ banner_shadow_rgba }};"
>
  <div class="custom-order-banner__inner">
    <div class="custom-order-banner__text-wrapper" data-text-wrapper>
      <span class="custom-order-banner__text custom-order-banner__text--editing" data-banner-editing hidden>
        {{ banner_editing_text | escape }}
      </span>
      <span class="custom-order-banner__text custom-order-banner__text--duplicate" aria-hidden="true" hidden></span>
    </div>
    <button
      type="button"
      class="custom-order-banner__close"
      aria-label="Minimize banner"
      data-banner-close
    >
      <svg aria-hidden="true" focusable="false" width="16" height="16" viewBox="0 0 16 16">
        <path d="M8 4L3 9l1.414 1.414L8 6.828l3.586 3.586L13 9l-5-5z" fill="currentColor"/>
      </svg>
    </button>
  </div>
  <div
    class="custom-order-banner__minimized"
    data-banner-minimized
    hidden
    role="button"
    tabindex="0"
    aria-label="Tap to show notification"
    title="Tap to show notification"
  >
    <div class="custom-order-banner__minimized-bar">
      <svg
        class="custom-order-banner__minimized-icon"
        aria-hidden="true"
        focusable="false"
        width="12"
        height="12"
        viewBox="0 0 12 12"
      >
        <path d="M6 2L2 6l4 4 4-4-4-4z" fill="currentColor" opacity="0.6"/>
      </svg>
    </div>
  </div>
</div>

{{ 'component-custom-order-banner.css' | asset_url | stylesheet_tag }}

<script>
  window.CustomOrderBanner = (function () {
    const banner = document.getElementById('custom-order-banner');
    if (!banner) {
      return {
        setForceShow() {},
        setBannerText() {},
        notifyEditing() {},
      };
    }

    const editingElement = banner.querySelector('[data-banner-editing]');
    const minimizedBar = banner.querySelector('[data-banner-minimized]');
    const editingTextDefault = {{ banner_editing_text | json }};
    const suppressed =
      window.location.pathname.includes('/checkouts/') ||
      window.location.pathname.includes('/checkout') ||
      window.location.pathname.includes('/thank-you');

    const state = {
      forceShow: false,
      editing: false,
      editingText: editingTextDefault,
    };

    let bannerManager = null;

    function render() {
      if (suppressed) {
        banner.hidden = true;
        if (minimizedBar) minimizedBar.hidden = true;
        return;
      }
      const showEditing = state.forceShow || state.editing;

      if (editingElement) {
        const text = state.editingText || editingTextDefault;
        if (typeof text === 'string') editingElement.textContent = text;
        editingElement.hidden = !showEditing;
      }

      if (showEditing) {
        banner.hidden = false;
        if (bannerManager && bannerManager.isMinimized()) {
          banner.classList.add('custom-order-banner--minimized');
        } else {
          banner.classList.remove('custom-order-banner--minimized');
        }
        // Check if text needs scrolling after rendering
        setTimeout(checkTextScroll, 100);
      } else {
        banner.hidden = true;
        if (minimizedBar) minimizedBar.hidden = true;
      }
    }

    function setForceShow(value) {
      state.forceShow = Boolean(value);
      if (value && bannerManager) {
        bannerManager.restore();
      }
      render();
    }

    function setBannerText(value) {
      const sanitized = value && value.trim() !== '' ? value.trim() : null;
      state.editingText = sanitized || editingTextDefault;
      render();
    }

    function notifyEditing(isEditing = true) {
      const nextFlag = Boolean(isEditing);
      if (state.editing !== nextFlag) {
        state.editing = nextFlag;
        if (nextFlag && bannerManager) {
          bannerManager.restore();
        }
        render();
      }
    }

    function checkTextScroll() {
      if (!editingElement) return;
      const container = editingElement.closest('.custom-order-banner__inner');
      const wrapper = editingElement.closest('[data-text-wrapper]');
      const duplicate = wrapper?.querySelector('.custom-order-banner__text--duplicate');
      if (!container || !wrapper) {
        if (duplicate) duplicate.hidden = true;
        return;
      }

      // Hide duplicate and remove scroll attributes on desktop
      if (window.innerWidth > 749) {
        if (duplicate) duplicate.hidden = true;
        wrapper.removeAttribute('data-needs-scroll');
        container.removeAttribute('data-needs-scroll');
        return;
      }

      // Account for padding on both sides and close button width (mobile only)
      const containerWidth = container.offsetWidth;
      const leftPadding = 16; // 1rem in pixels
      const rightPadding = 56; // 3.5rem for close button area
      const availableWidth = containerWidth - leftPadding - rightPadding;
      const textWidth = editingElement.scrollWidth;

      if (textWidth > availableWidth && duplicate) {
        // Duplicate text for seamless scrolling
        duplicate.textContent = editingElement.textContent;
        duplicate.hidden = false;
        wrapper.setAttribute('data-needs-scroll', 'true');
        container.setAttribute('data-needs-scroll', 'true');
      } else {
        if (duplicate) duplicate.hidden = true;
        wrapper.removeAttribute('data-needs-scroll');
        container.removeAttribute('data-needs-scroll');
      }
    }

    async function init() {
      if (window.CustomBannerManager) {
        bannerManager = window.CustomBannerManager.initBanner({
          banner,
          minimizedBar,
          storageKey: 'editingBanner',
          autoRestoreOnShow: true,
        });
      }

      // Check if text needs scrolling on all screen sizes (responds to resize)
      checkTextScroll();
      window.addEventListener('resize', checkTextScroll);

      const isProductPage = window.location.pathname.includes('/products/');
      const hasCustomForm = document.querySelector('.measurement-field') || document.querySelector('.category-option-input');

      let hasEditParams = false;
      if (window.CustomOrderUtils && window.CustomOrderUtils.hasEditRelatedParams) {
        try {
          hasEditParams = await window.CustomOrderUtils.hasEditRelatedParams();
        } catch (error) {
          console.warn('Error checking edit params:', error);
          hasEditParams = false;
        }
      }

      if (hasEditParams && isProductPage && hasCustomForm) {
        state.editing = true;
      }

      render();
      subscribe(PUB_SUB_EVENTS.cartUpdate, (event) => {
        if (event.customOrderItemAdded) {
          state.editing = false;
          state.forceShow = false;
          if (bannerManager) bannerManager.restore();
          render();
        }
      });
      window.addEventListener('custom-order:editing', () => notifyEditing(true));
      window.addEventListener('custom-order:editing-stop', () => notifyEditing(false));
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    return {
      setForceShow,
      setBannerText,
      notifyEditing,
    };
  })();
</script>
