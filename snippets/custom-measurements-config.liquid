{% comment %}
  Custom Measurements Configuration
  Reads from theme settings and outputs JavaScript config object
  This snippet can be included in any template that needs custom measurements
{% endcomment %}

{%- comment -%} Parse categories order {%- endcomment -%}
{%- comment -%} Use settings directly - defaults are defined in settings_schema.json {%- endcomment -%}
{%- assign categories_source = settings.custom_measurements_categories_order -%}
{%- assign categories_order = categories_source | split: ',' -%}

{%- comment -%} Parse product type mapping {%- endcomment -%}
{%- assign type_map_source = settings.custom_measurements_product_type_map | default: '' -%}
{%- assign product_type = product.type | default: '' -%}
{%- assign auto_selected_category = '' -%}
{%- assign product_type_not_found = false -%}
{%- if type_map_source != '' and product_type != '' -%}
  {%- assign type_map_lines = type_map_source | newline_to_br | split: '<br />' -%}
  {%- for line in type_map_lines -%}
    {%- assign line = line | strip -%}
    {%- if line == '' -%}{% continue %}{% endif %}
    {%- assign parts = line | split: ':' -%}
    {%- if parts.size >= 2 -%}
      {%- assign type_name = parts[0] | strip -%}
      {%- assign type_name_lower = type_name | downcase -%}
      {%- assign product_type_lower = product_type | downcase -%}
      {%- if type_name == product_type or type_name_lower == product_type_lower -%}
        {%- assign auto_selected_category = parts[1] | strip -%}
        {%- break -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  {%- comment -%} Check if product type exists but no match found {%- endcomment -%}
  {%- if auto_selected_category == '' -%}
    {%- assign product_type_not_found = true -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%} Parse measurement map {%- endcomment -%}
{%- comment -%} Use settings directly - defaults are defined in settings_schema.json {%- endcomment -%}
{%- assign measurement_map_source = settings.custom_measurements_map -%}
{%- assign measurement_map_lines = measurement_map_source | newline_to_br | split: '<br />' -%}

{%- comment -%} Build measurements config object {%- endcomment -%}
{%- assign measurement_names = '' | split: '|' -%}
{%- for measurement_line in measurement_map_lines -%}
  {%- assign measurement_line = measurement_line | strip -%}
  {%- if measurement_line == '' -%}{% continue %}{% endif %}
  {%- assign parts = measurement_line | split: ':' -%}
  {%- assign measurement_label = parts[0] | strip -%}
  {%- if measurement_label == '' -%}{% continue %}{% endif %}
  {%- comment -%} Strip asterisks from measurement label {%- endcomment -%}
  {%- assign measurement_label = measurement_label | remove: '*' | strip -%}
  {%- assign measurement_entry = measurement_label | split: '__split__' -%}
  {%- assign measurement_names = measurement_names | concat: measurement_entry -%}
{%- endfor -%}
{%- assign measurement_names = measurement_names | uniq -%}

{%- comment -%} Parse harness categories (now single "Harness" category) {%- endcomment -%}
{%- assign default_harness_categories = 'Harness' -%}
{%- assign harness_source_raw = settings.custom_measurements_harness_categories
  | default: default_harness_categories
-%}
{%- assign harness_source = harness_source_raw | replace: '|', ',' -%}
{%- assign harness_categories = harness_source | split: ',' -%}

{%- comment -%} Parse harness types {%- endcomment -%}
{%- assign default_harness_types = 'Deluxe Harness, Standard Harness, Suspender Harness, Asymmetric Harness' -%}
{%- assign harness_types_source_raw = settings.custom_measurements_harness_types | default: default_harness_types -%}
{%- assign harness_types_source = harness_types_source_raw | replace: '|', ',' -%}
{%- assign harness_types = harness_types_source | split: ',' -%}

{%- comment -%} Parse tag options {%- endcomment -%}
{%- assign default_tag_options = 'Dog Tag, Pig Tag, Bear Tag, Puppy Bone, Puppy Paw, Other' -%}
{%- assign tag_options_source_raw = settings.custom_measurements_tag_options | default: default_tag_options -%}
{%- assign tag_options_source = tag_options_source_raw | replace: '|', ',' -%}
{%- assign tag_options = tag_options_source | split: ',' -%}

{%- comment -%} Parse options {%- endcomment -%}
{%- assign default_leather_colors = 'Black, White, Red, Blue, Green, Yellow, Orange, Purple' -%}
{%- assign leather_source_raw = settings.custom_measurements_leather_colors | default: default_leather_colors -%}
{%- assign leather_source = leather_source_raw | replace: '|', ',' -%}
{%- assign leather_colors = leather_source | split: ',' -%}

{%- assign default_front_plate_options = 'Bear Paw, Puppy Paw, Fist Image, Pig Image, Boot Image, Biohazard Symbol, Cigar Man' -%}
{%- assign front_plate_source_raw = settings.custom_measurements_front_plate_options
  | default: default_front_plate_options
-%}
{%- assign front_plate_source = front_plate_source_raw | replace: '|', ',' -%}
{%- assign front_plate_options = front_plate_source | split: ',' -%}

{%- assign default_back_plate_extra = 'Wesco Boot, Watersports, Happy Puppy' -%}
{%- assign back_plate_extra_source_raw = settings.custom_measurements_back_plate_extra
  | default: default_back_plate_extra
-%}
{%- assign back_plate_extra_source = back_plate_extra_source_raw | replace: '|', ',' -%}
{%- assign back_plate_extra = back_plate_extra_source | split: ',' -%}
{%- assign back_plate_options = front_plate_options | concat: back_plate_extra -%}

{%- assign default_long_sliders = 'None, Brass, Steel' -%}
{%- assign long_sliders_source_raw = settings.custom_measurements_long_sliders | default: default_long_sliders -%}
{%- assign long_sliders_source = long_sliders_source_raw | replace: '|', ',' -%}
{%- assign long_sliders = long_sliders_source | split: ',' -%}

{%- assign default_associates = 'Clair, Erik, Other' -%}
{%- assign associates_source_raw = settings.custom_measurements_associates | default: default_associates -%}
{%- assign associates_source = associates_source_raw | replace: '|', ',' -%}
{%- assign associates = associates_source | split: ',' -%}

{%- comment -%} Build product type map object {%- endcomment -%}
{%- comment -%} We'll build the JSON directly in the script tag to avoid HTML entity encoding {%- endcomment -%}

{%- comment -%} Build JavaScript config object {%- endcomment -%}
<script>
  window.customMeasurementsConfig = {
    productTypeMap: {
      {%- if type_map_source != '' -%}
        {%- assign type_map_lines = type_map_source | newline_to_br | split: '<br />' -%}
        {%- assign first_entry = true -%}
        {%- for line in type_map_lines -%}
          {%- assign line = line | strip -%}
          {%- if line == '' -%}{% continue %}{% endif %}
          {%- assign parts = line | split: ':' -%}
          {%- if parts.size >= 2 -%}
            {%- assign type_name = parts[0] | strip -%}
            {%- assign category_name = parts[1] | strip -%}
            {%- if type_name != '' and category_name != '' -%}
              {%- unless first_entry -%},{%- endunless -%}
              {%- assign first_entry = false -%}
              "{{ type_name | replace: '"', '\"' }}": "{{ category_name | replace: '"', '\"' }}"
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    },
    autoSelectedCategory: {% if auto_selected_category != '' %}"{{ auto_selected_category | escape }}"{% else %}null{% endif %},
    categories: [
      {%- for category in categories_order -%}
        {%- assign category_clean = category | strip -%}
        {%- if category_clean == '' -%}{% continue %}{% endif %}
        "{{ category_clean | escape }}"{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],
    measurements: {
      {%- for meas_name in measurement_names -%}
        {%- assign measurement_label = meas_name | strip -%}
        {%- if measurement_label == '' -%}{% continue %}{% endif %}
        "{{ measurement_label | escape }}": {
          categories: {
            {%- for category in categories_order -%}
              {%- assign category_name = category | strip -%}
              {%- if category_name == '' -%}{% continue %}{% endif %}
              {%- assign is_required = false -%}
              {%- assign is_included = false -%}
              {%- for measurement_line in measurement_map_lines -%}
                {%- assign measurement_line = measurement_line | strip -%}
                {%- if measurement_line == '' -%}{% continue %}{% endif %}
                {%- assign parts = measurement_line | split: ':' -%}
                {%- assign meas_label = parts[0] | strip | remove: '*' | strip -%}
                {%- if meas_label != measurement_label -%}{% continue %}{% endif %}
                {%- assign categories_part = '' -%}
                {%- if parts.size > 1 -%}
                  {%- assign categories_part = parts[1] -%}
                {%- endif -%}
                {%- assign category_tokens = categories_part | split: ',' -%}
                {%- for token in category_tokens -%}
                  {%- assign token_clean = token | strip -%}
                  {%- if token_clean == '' -%}{% continue %}{% endif %}
                  {%- assign base_category = token_clean | remove: '*' | strip -%}
                  {%- if base_category == category_name -%}
                    {%- assign is_included = true -%}
                    {%- if base_category == token_clean -%}
                      {%- assign is_required = true -%}
                    {%- endif -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if is_included -%}{% break %}{% endif -%}
              {%- endfor -%}
              {%- if is_included -%}
                "{{ category_name | escape }}": {
                  included: true,
                  required: {% if is_required %}true{% else %}false{% endif %}
                }{% unless forloop.last %},{% endunless %}
              {%- endif -%}
            {%- endfor -%}
          }
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    },
    harnessCategories: [
      {%- for harness in harness_categories -%}
        {%- assign harness_clean = harness | strip -%}
        {%- if harness_clean == '' -%}{% continue %}{% endif %}
        "{{ harness_clean | escape }}"{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],
    categoryConfig: {
      harness_details: [
        {%- for harness in harness_categories -%}
          {%- assign harness_clean = harness | strip -%}
          {%- if harness_clean == '' -%}{% continue %}{% endif %}
          "{{ harness_clean | escape }}"{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ]
    },
    options: {
      leatherColors: [
        {%- for color in leather_colors -%}
          {%- assign color_clean = color | strip -%}
          {%- if color_clean == '' -%}{% continue %}{% endif %}
          "{{ color_clean | escape }}"{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ],
      frontPlates: [
        {%- for plate in front_plate_options -%}
          {%- assign plate_clean = plate | strip -%}
          {%- if plate_clean == '' -%}{% continue %}{% endif %}
          "{{ plate_clean | escape }}"{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ],
      backPlates: [
        {%- for plate in back_plate_options -%}
          {%- assign plate_clean = plate | strip -%}
          {%- if plate_clean == '' -%}{% continue %}{% endif %}
          "{{ plate_clean | escape }}"{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ],
      longSliders: [
        {%- for slider in long_sliders -%}
          {%- assign slider_clean = slider | strip -%}
          {%- if slider_clean == '' -%}{% continue %}{% endif %}
          "{{ slider_clean | escape }}"{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ],
      associates: [
        {%- for associate in associates -%}
          {%- assign associate_clean = associate | strip -%}
          {%- if associate_clean == '' -%}{% continue %}{% endif %}
          "{{ associate_clean | escape }}"{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ],
      harnessTypes: [
        {%- for type in harness_types -%}
          {%- assign type_clean = type | strip -%}
          {%- if type_clean == '' -%}{% continue %}{% endif %}
          "{{ type_clean | escape }}"{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ],
      tagOptions: [
        {%- for option in tag_options -%}
          {%- assign option_clean = option | strip -%}
          {%- if option_clean == '' -%}{% continue %}{% endif %}
          "{{ option_clean | escape }}"{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ]
    },
    precision: {{ settings.custom_measurements_precision | default: 3 }},
    constants: {
      INCH_TO_CM: 2.54,
      CM_TO_INCH: 0.393700787
    },
    customOrderProductTitle: {{ settings.custom_order_product_title | default: 'Custom Order' | json }},
    customTextMaxLengthDefault: 50
  };
</script>

{%- comment -%} Display helper tool if product type not found in settings {%- endcomment -%}
{%- if product_type_not_found -%}
  <div class="product-form__input" style="margin-bottom: 2rem;">
    <div style="background-color: rgb(var(--color-background)); border: 0.1rem solid rgba(var(--color-foreground), 0.08); border-radius: var(--inputs-radius, 0.4rem); padding: 2rem;">
      <div style="margin-bottom: 1.5rem;">
        <p style="margin: 0 0 0.5rem 0; font-size: 1.4rem; color: rgb(var(--color-foreground));">
          Product type "<strong>{{ product_type | escape }}</strong>" needs to be mapped to a category.
        </p>
        <p style="margin: 0; font-size: 1.2rem; color: rgba(var(--color-foreground), 0.7);">
          Select a category below and copy the mapping text to add to Theme Settings → Custom Order Measurements Settings → Product Type Map.
        </p>
      </div>

      <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;">
        <div class="select" style="position: relative;">
          <select id="product-type-category-select" class="select__select" required style="width: 100%;">
            <option value="">Select category...</option>
            {%- for category in categories_order -%}
              {%- assign category_clean = category | strip -%}
              {%- if category_clean != '' -%}
                <option value="{{ category_clean | escape }}">{{ category_clean | escape }}</option>
              {%- endif -%}
            {%- endfor -%}
          </select>
        </div>
        <button type="button" id="product-type-copy-btn" class="button" style="white-space: nowrap; min-width: 12rem;" disabled>
          Copy Mapping
        </button>
      </div>

      <div id="product-type-formatted-text" style="background-color: rgba(var(--color-foreground), 0.03); padding: 1rem; border-radius: var(--inputs-radius, 0.4rem); border: 0.1rem solid rgba(var(--color-foreground), 0.08); font-family: monospace; font-size: 1.3rem; color: rgb(var(--color-foreground)); min-height: 1.5rem; display: flex; align-items: center;">
        <span style="color: rgba(var(--color-foreground), 0.5);">Select a category to generate mapping text</span>
      </div>
    </div>
  </div>

  <script>
    (function() {
      var productType = {{ product_type | json }};
      var categorySelect = document.getElementById('product-type-category-select');
      var copyBtn = document.getElementById('product-type-copy-btn');
      var formattedText = document.getElementById('product-type-formatted-text');

      if (!categorySelect || !copyBtn || !formattedText) return;

      function updateFormattedText() {
        var selectedCategory = categorySelect.value;
        if (selectedCategory) {
          var text = productType + ': ' + selectedCategory;
          formattedText.innerHTML = '<span>' + escapeHtml(text) + '</span>';
          copyBtn.disabled = false;
          copyBtn.setAttribute('aria-disabled', 'false');
        } else {
          formattedText.innerHTML = '<span style="color: rgba(var(--color-foreground), 0.5);">Select a category to generate mapping text</span>';
          copyBtn.disabled = true;
          copyBtn.setAttribute('aria-disabled', 'true');
        }
      }

      function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      categorySelect.addEventListener('change', updateFormattedText);

      copyBtn.addEventListener('click', function() {
        var selectedCategory = categorySelect.value;
        if (!selectedCategory) return;

        var textToCopy = productType + ': ' + selectedCategory;

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(textToCopy).then(function() {
            var originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            setTimeout(function() {
              copyBtn.textContent = originalText;
            }, 2000);
          }).catch(function(err) {
            console.error('Failed to copy text:', err);
            fallbackCopy(textToCopy);
          });
        } else {
          fallbackCopy(textToCopy);
        }
      });

      function fallbackCopy(text) {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          var originalText = copyBtn.textContent;
          copyBtn.textContent = 'Copied!';
          setTimeout(function() {
            copyBtn.textContent = originalText;
          }, 2000);
        } catch (err) {
          console.error('Fallback copy failed:', err);
        }
        document.body.removeChild(textarea);
      }
    })();
  </script>
{%- endif -%}
