{% comment %}
  Renders variant options (color/size) for product cards

  Accepts:
  - product: {Object} Product Liquid object (required)

  Usage:
  {% render 'custom-card-variant-options', product: product %}
{% endcomment %}

{%- if product and product.has_only_default_variant == false -%}
  {%- comment -%} Check if product has color and size options with multiple values {%- endcomment -%}
  {%- liquid
    assign show_color_option = false
    assign show_size_option = false
    assign color_option = null
    assign size_option = null

    for option in product.options_with_values
      assign option_name_lower = option.name | downcase
      if option_name_lower == 'color' or option_name_lower == 'colour'
        assign color_option = option
        if option.values.size > 1
          assign show_color_option = true
        endif
      elsif option_name_lower == 'size'
        assign size_option = option
        if option.values.size > 1
          assign show_size_option = true
        endif
      endif
    endfor
  -%}

  {%- comment -%} Display if color or size options have multiple values {%- endcomment -%}
  {%- if show_color_option or show_size_option -%}
    {%- comment -%} Load CSS only once per page {%- endcomment -%}
    {%- unless custom_card_variant_options_loaded -%}
      {{ 'component-custom-card-variant-options.css' | asset_url | stylesheet_tag }}
      {%- assign custom_card_variant_options_loaded = true -%}
    {%- endunless -%}

    <div class="custom-card-variant-options">
      {%- comment -%} Display Color Option (only if multiple values) {%- endcomment -%}
      {%- if show_color_option and color_option -%}
        <div class="custom-card-variant-options__group" data-option-name="{{ color_option.name | escape }}">
          <div class="custom-card-variant-options__swatches">
            {%- for value in color_option.values -%}
              {%- liquid
                assign value_unavailable = true

                for variant in product.variants
                  assign variant_has_value = false
                  if color_option.position == 1 and variant.option1 == value
                    assign variant_has_value = true
                  elsif color_option.position == 2 and variant.option2 == value
                    assign variant_has_value = true
                  elsif color_option.position == 3 and variant.option3 == value
                    assign variant_has_value = true
                  endif

                  if variant_has_value
                    if variant.inventory_management == 'shopify'
                      if variant.inventory_quantity > 0
                        assign value_unavailable = false
                        break
                      endif
                    else
                      assign value_unavailable = false
                      break
                    endif
                  endif
                endfor
              -%}

              <div
                class="custom-card-variant-options__option custom-card-variant-options__option--swatch{% if value_unavailable %} custom-card-variant-options__option--unavailable{% endif %}"
                title="{{ value | escape }}"
                aria-label="{{ value | escape }}{% if value_unavailable %} - {{ 'products.product.sold_out' | t }}{% endif %}"
              >
                {% render 'swatch', swatch: value.swatch, shape: 'square' %}
              </div>
            {%- endfor -%}
          </div>
        </div>
      {%- endif -%}

      {%- comment -%} Display Size Option (only if multiple values) {%- endcomment -%}
      {%- if show_size_option and size_option -%}
        <div class="custom-card-variant-options__group" data-option-name="{{ size_option.name | escape }}">
          <div class="custom-card-variant-options__buttons">
            {%- for value in size_option.values -%}
              {%- liquid
                assign value_unavailable = true

                for variant in product.variants
                  assign variant_has_value = false
                  if size_option.position == 1 and variant.option1 == value
                    assign variant_has_value = true
                  elsif size_option.position == 2 and variant.option2 == value
                    assign variant_has_value = true
                  elsif size_option.position == 3 and variant.option3 == value
                    assign variant_has_value = true
                  endif

                  if variant_has_value
                    if variant.inventory_management == 'shopify'
                      if variant.inventory_quantity > 0
                        assign value_unavailable = false
                        break
                      endif
                    else
                      assign value_unavailable = false
                      break
                    endif
                  endif
                endfor
              -%}

              <div
                class="custom-card-variant-options__option custom-card-variant-options__option--button{% if value_unavailable %} custom-card-variant-options__option--unavailable{% endif %}"
                title="{{ value | escape }}{% if value_unavailable %} - {{ 'products.product.sold_out' | t }}{% endif %}"
                aria-label="{{ value | escape }}{% if value_unavailable %} - {{ 'products.product.sold_out' | t }}{% endif %}"
              >
                <span class="custom-card-variant-options__button-text">{{ value | escape }}</span>
              </div>
            {%- endfor -%}
          </div>
        </div>
      {%- endif -%}
    </div>
  {%- endif -%}
{%- endif -%}
